<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Nginx & PHP important security issue</title>

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  

  <meta property="og:site_name" content="Codingarena" />
  <meta property="og:title" content="Nginx & PHP important security issue"/>
  
  <meta property="og:description" content="A critical security issue has recently been pointed out on servers that run Nginx and PHP via FastCGI. The issue allows anyone to execute their own PHP code on the system, I don’t think I have to r..." />
  
  <meta property="og:image" content="http://codingarena.in/blog/assets/images/manu.png" />
  <meta property="og:url" content="http://codingarena.in/blog/blog/2012/08/19/nginx-php-important-security-issue/" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2012-08-19T00:00:00+05:30">

  <link rel="canonical" href="http://codingarena.in/blog/blog/2012/08/19/nginx-php-important-security-issue/">

  <link rel="shortcut icon" href="/blog/assets/images/favicon.ico">
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/blog/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/blog/css/print.css" />
</head>
  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://codingarena.in" class="logo-readium"><span class="logo" style="background-image: url(/blog/assets/images/manu.png)"></span></a>

<!-- header end -->
    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">Nginx & PHP important security issue</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/blog/assets/images/manu.png)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2012-08-19T00:00:00+05:30">19 Aug 2012</time>
              tagged on <span class="post-tag-">, <a href="/tag/"></a></span>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>A critical security issue has recently been pointed out on servers that run Nginx and PHP via FastCGI. The issue allows anyone to execute their own PHP code on the system, I don’t think I have to remind you of the consequences this could have. I will attempt to provide a simple explanation of the issue and more importantly how to fix it.</p>

<!--more-->

<h2 id="what-is-the-issue">What is the issue?</h2>
<p>I would like to begin by discussing the nature of the problem: it is not caused by Nginx itself - it is not a bug or a security breach in itself. Actually, it is the way that people usually configure Nginx FastCGI options to work with PHP, and how PHP reacts to that configuration. Pretty much everyone adopts the same configuration without being aware of the issue.</p>

<p>The issue itself can be understood simply, then I will explain why PHP behaves that way. Most dynamic websites allow for a reason or another uploading of files. Say, I’m running a forum-based community, users can upload images to use as personal photo or avatar. The photo gets uploaded and you get the following URL:</p>

<p><code><em>http://myforum.com/uploads/photo1234.jpg</em></code></p>

<p>The breach consists in appending an additional path element to the URL, making it end in .php:</p>

<p><code><em>http://myforum.com/uploads/photo1234.jpg/anything.php</em></code></p>

<p>Under certain conditions (and unfortunately with default settings), your photo1234.jpg gets processed as PHP file. So you could upload a PHP script renamed as .jpg, upload the image, then execute the script on the server.</p>

<p>If you want to know instantly if your server is vulnerable to this attack, there is a simple way to know. Find a regular file on your server, such as</p>

<p><code><em>http://myforum.com/robots.txt.</em></code></p>

<p>Examine the HTTP headers of the response:
    HTTP/1.1 200 OK
    Server: nginx/0.7.64
    Date: Wed, 26 May 2010 10:56:01 GMT
    Content-Type: text/plain
    Content-Length: 43
    (…)</p>

<p>Now add /test.php after the URL:</p>

<p><code><em> http://myforum.com/robots.txt/test.php: </em></code></p>

<pre><code>HTTP/1.1 200 OK
Server: nginx/0.7.64
Date: Wed, 26 May 2010 10:56:01 GMT
Content-Type: text/plain
Content-Length: 43
(...)
X-Powered-By: PHP/5.2.3
</code></pre>

<p>The X-Powered-By header was added by PHP which shows that the file was processed by PHP. Now visit that URL http://myforum.com/robots.txt/test.php in your web browser. What do you see:</p>

<ul>
  <li>do you see the robots.txt file ? if so, your server is vulnerable.</li>
  <li>do you see an error page (403, 404, 500, 502…) or just a simple message “No input file specified” ? if so, your server is not affected by the problem.</li>
</ul>

<h2 id="why-does-this-happen">Why does this happen?</h2>
<p>There are two main reasons why this happens. First let’s have a look at the data Nginx transmits to PHP.
A regular FastCGI/PHP configuration would be as follows:</p>

<pre><code>fastcgi_pass 127.0.0.1:9000;
fastcgi_index index.php;
fastcgi_param SCRIPT_FILENAME &lt;em&gt;/var/www/vhosts/myforum.com/httpdocs$fastcgi_script_name;&lt;/em&gt;
fastcgi_param PATH_INFO $fastcgi_script_name;
</code></pre>

<p>When requesting an URL like<em> http://myforum.com/uploads/photo1234.jpg/anything.php</em> to Nginx, here is the data that gets sent:</p>

<pre><code>fastcgi_param SCRIPT_FILENAME &lt;em&gt;/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg/anything.php;&lt;/em&gt;
fastcgi_param PATH_INFO /robots.txt/test.php;
</code></pre>

<p>So far, no problem. PHP is supposed to load a file anything.php, in the directory <em>/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg/.</em> Naturally, this directory should not exist, and anything.php shouldn’t exist either, so we should be getting a 404 error.
However, that’s where the problem comes in. The PHP option cgi.fix_pathinfo, when enabled (and it is usually enabled by default) will transform these two parameters. The SCRIPT_FILENAME becomes <em>/var/www/vhosts/myforum.com/httpdocs/uploads/photo1234.jpg,</em> which means the .jpg file actually becomes the request filename, and it gets treated as PHP. And PATH_INFO becomes /anything.php. The original purpose of this option was to allow such kind of URLs: index.php/param1/param2/…
But when combined with Nginx, this turns into a major issue.</p>

<h2 id="how-do-i-fix-it">How do I fix it?</h2>
<p>Well, the simplest thing you can do is open up your php.ini configuration file, and insert this directive in the main section:
    cgi.fix_pathinfo=0
Then restart PHP-FPM or whatever FastCGI manager you’re using.</p>

<p>Unfortunately in some cases that is not possible a solution, since perhaps other scripts on your server make the most of this option. So you could do mainly employ two different solutions on the Nginx side.</p>

<p>First, you could check that the requested URI actually exists, before passing the request via FastCGI:</p>

<pre><code>location \.php$ {
    if (!-f $request_filename) {
        return 404;
    }
    fastcgi_pass 127.0.0.1:9000;
    [...]
}
</code></pre>

<p>This solution is efficient and a few of us Nginx+PHP have retained it.
Otherwise, if you think it’s too consuming in terms of resources, you could check the URI to meet the following requirements:
- if the URI contains a dot, then a slash (example: image.jpg/…)
- if the URI ends with “.php” (example: image.jpg/test.php)
- then return a 403 error.
    location ~ ..<em>/.</em>.php$ {
        return 403;
    }
    location ~ .php$ {
        fastcgi_pass 127.0.0.1:9000;
        …
    }</p>

<p>Alternatively, you could make sure that PHP is only enabled in certain directories, where file uploads are not allowed:
    location ~ ^/(scripts|sources|src)/.*.php$ {
        fastcgi_pass 127.0.0.1:9000;
        …
    }</p>

<p><a href="http://facebook.com/manusajth">Manu</a></p>

<p><a href="www.codingarena.in">www.codingarena.in</a></p>

<table>
  <tbody>
    <tr>
      <td><a href="http://twitter.com/manusajith" title="Twitter">@manusajith</a></td>
      <td><a href="http://github.com/manusajith" title="Github">@github</a></td>
    </tr>
  </tbody>
</table>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=Nginx+%26+PHP+important+security+issue&amp;url=http://codingarena.in/blog/2012/08/19/nginx-php-important-security-issue"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/blog/assets/images/manu.png)">Blog Logo</div>
              <h4>Manu S Ajith</h4>
              <p class="bio" style="width:200%"> #programmer, #hacker, #entrepreneur, open source evangelist. #Ruby, #Golang, #Elixir, #JS, Lazy #Blogger. Writes #code for a living.</p>
              <hr>
              <p class="published">Published <time datetime="2012-08-19 00:00">19 Aug 2012</time></p>
            </section>
          </div>
          
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'codingarenablog'; // required: replace example with your forum shortname
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="inner">
        <a href="/blog/" class="btn">Back to Home</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/blog/assets/js/index.js"></script>
<script type="text/javascript" src="/blog/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>
  </body>
</html>
