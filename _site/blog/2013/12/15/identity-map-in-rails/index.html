<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
  <!-- (1) Optimize for mobile versions: http://goo.gl/EOpFl -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- (1) force latest IE rendering engine: bit.ly/1c8EiC9 -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>identity_map_in_rails</title>

  <meta name="HandheldFriendly" content="True" />
  <meta name="MobileOptimized" content="320" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  

  <meta property="og:site_name" content="Codingarena" />
  <meta property="og:title" content="identity_map_in_rails"/>
  
  <meta property="og:description" content="I was recently working on a project that was’nt maintained for some time and the test cases were failing too. I started upgrading the application to the latest version and some of the test cases we..." />
  
  <meta property="og:image" content="http://codingarena.in/blog/assets/images/manu.png" />
  <meta property="og:url" content="http://codingarena.in/blog/blog/2013/12/15/identity-map-in-rails/" >
  <meta property="og:type" content="blog" />
  <meta property="article:published_time" content="2013-12-15T04:07:41+05:30">

  <link rel="canonical" href="http://codingarena.in/blog/blog/2013/12/15/identity-map-in-rails/">

  <link rel="shortcut icon" href="/blog/assets/images/favicon.ico">
  <link rel="stylesheet" href="//brick.a.ssl.fastly.net/Linux+Libertine:400,400i,700,700i/Open+Sans:400,400i,700,700i">
  <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

  <link rel="stylesheet" type="text/css" media="screen" href="/blog/css/main.css" />
  <link rel="stylesheet" type="text/css" media="print" href="/blog/css/print.css" />
</head>
  <body itemscope itemtype="http://schema.org/Article">
    <!-- header start -->

<a href="http://codingarena.in" class="logo-readium"><span class="logo" style="background-image: url(/blog/assets/images/manu.png)"></span></a>

<!-- header end -->
    <main class="content" role="main">
      <article class="post">
        
        <div class="noarticleimage">
          <div class="post-meta">
            <h1 class="post-title">identity_map_in_rails</h1>
            <div class="cf post-meta-text">
              <div class="author-image" style="background-image: url(/blog/assets/images/manu.png)">Blog Logo</div>
              <h4 class="author-name" itemprop="author" itemscope itemtype="http://schema.org/Person"></h4>
              on
              <time datetime="2013-12-15T04:07:41+05:30">15 Dec 2013</time>
              tagged on <span class="post-tag-">, <a href="/tag/"></a></span>
            </div>
          </div>
        </div>
        <br>
        <br>
        <br>
        
        <section class="post-content">
          <div class="post-reading">
            <span class="post-reading-time"></span> read
          </div>
          <a name="topofpage"></a>
          <p>I was recently working on a project that was’nt maintained for some time and the test cases were failing too. I started upgrading the application to the latest version and some of the test cases were still failing.
Looking deeper into the logs I could find that I was getting an wierd error with IdentityMap when using with a Rails4 app. I did some googling and found that identity_map was removed from Rails4.</p>

<h2 id="what-is-identitymap-">What is IdentityMap ?</h2>

<p>Ensures that each object gets loaded only once by keeping every loaded object in a map. Looks up objects using the map when referring to them. More details on the IdentityMap pattern can be found <a href="'http://www.martinfowler.com/eaaCatalog/identityMap.html'">here</a> on a blog post by Martin Fowler</p>

<!--more -->

<h2 id="configuration">Configuration</h2>

<p>In order to enable IdentityMap, set <code>config.active_record.identity_map = true</code> in your config/application.rb file.</p>

<p>Identitymap configuration has been removed from Rails4. If you are upgrading Rails 4 from Rails 3, then please be sure to remove/comment the line from config/application.rb</p>

<h2 id="issues-with-identitymap">Issues with IdentityMap</h2>

<h3 id="associations">Associations</h3>

<p>Active Record Identity Map does not track associations yet. For example:</p>

<pre><code>comment = @post.comments.first
comment.post = nil
@post.comments.include?(comment) #=&gt; true
</code></pre>

<p>Ideally, the example above would return false, removing the comment object from the post association when the association is nullified. This may cause side effects, as in the situation below, if Identity Map is enabled:</p>

<pre><code>Post.has_many :comments, :dependent =&gt; :destroy

comment = @post.comments.first
comment.post = nil
comment.save
Post.destroy(@post.id)
</code></pre>

<p>Without using Identity Map, the code above will destroy the @post object leaving the comment object intact. However, once we enable Identity Map, the post loaded by Post.destroy is exactly the same object as the object @post. As the object @post still has the comment object in @post.comments, once Identity Map is enabled, the comment object will be accidently removed.</p>

<p>This inconsistency wasnt fixed and was the main reason for the removal of identitymao from Rails4.</p>

<p>Other two minor problems are:</p>

<p>If you inheriting models, and you want to switch from one typo of object to another, then first you need delete your object from identity map, and after that create a new object. Example:</p>

<pre><code>class A &lt; ActiveRecord::Base
end

class B &lt; ActiveRecord::Base
end

a = A.create!
a.update_attribute :type, 'B'
b = B.find a.id
#=&gt; #&lt;A:...&gt;
ActiveRecord::IdentityMap.remove(a) if ActiveRecord::IdentityMap.enabled?
b = B.find a.id
#=&gt; #&lt;B:...&gt;
</code></pre>

<p>Another small issue is that the identity map may mees up the thing in the tests. As it do not truncates its repository after each test. To make it to do so one needs to add that into test framework configurations. Rspec example:</p>

<pre><code>RSpec.configure do |config|
  config.after :each do
    DatabaseCleaner.clean
    ActiveRecord::IdentityMap.clear
  end
end
</code></pre>

<p>My opinion is that identity map may be used, but partially. It is a bad idea to enable it by default for each single object, but it will be a good idea to enable it to specific models. Say, you have a table of languages, which is pretty static data, or may by countries. Why not to load them all in to identity map. But, with dynamic data (like users, or something different, that constantly changes), there is no need to store that in the memory.</p>

<p>The official documentation states clearly that the identitymap is still under development, so no one should really be using it in the wild.</p>

        </section>
        <footer class="post-footer">
          <section class="share">
            
              
                <a class="icon-twitter" href="http://twitter.com/share?text=identity_map_in_rails&amp;url=http://codingarena.in/blog/2013/12/15/identity-map-in-rails"
                  onclick="window.open(this.href, 'twitter-share', 'width=550,height=255');return false;">
                <i class="fa fa-twitter"></i><span class="hidden">twitter</span>
                </a>
              
            
              
            
          </section>
        </footer>
        <div class="bottom-teaser cf">
          <div class="isLeft">
            <h5 class="index-headline featured"><span>Written by</span></h5>
            <section class="author">
              <div class="author-image" style="background-image: url(/blog/assets/images/manu.png)">Blog Logo</div>
              <h4>Manu S Ajith</h4>
              <p class="bio" style="width:200%"> #programmer, #hacker, #entrepreneur, open source evangelist. #Ruby, #Golang, #Elixir, #JS, Lazy #Blogger. Writes #code for a living.</p>
              <hr>
              <p class="published">Published <time datetime="2013-12-15 04:07">15 Dec 2013</time></p>
            </section>
          </div>
          
        </div>
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = 'codingarenablog'; // required: replace example with your forum shortname
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        
      </article>
    </main>
    <div class="bottom-closer">
      <div class="inner">
        <a href="/blog/" class="btn">Back to Home</a>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="/blog/assets/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/blog/assets/js/index.js"></script>
<script type="text/javascript" src="/blog/assets/js/readingTime.min.js"></script>
<script>
(function ($) {
  "use strict";
  $(document).ready(function(){

    var $window = $(window),
    $image = $('.post-image-image, .teaserimage-image');
    
      $window.on('scroll', function() {
        var top = $window.scrollTop();

        if (top < 0 || top > 1500) { return; }
        $image
          .css('transform', 'translate3d(0px, '+top/3+'px, 0px)')
          .css('opacity', 1-Math.max(top/700, 0));
      });
      $window.trigger('scroll');

      var height = $('.article-image').height();
      $('.post-content').css('padding-top', height + 'px');

      $('a[href*=#]:not([href=#])').click(function() {
        if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'')
         && location.hostname == this.hostname) {
          var target = $(this.hash);
          target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
          if (target.length) {
            $('html,body').animate({ scrollTop: target.offset().top }, 500);
            return false;
          }
        }
      });

  });
}(jQuery));
</script>
  </body>
</html>
